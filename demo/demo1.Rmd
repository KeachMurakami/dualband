---
title: "demo"
author: "Keach Murakami"
output: html_document
---

```{r setup}
knitr::opts_chunk$set(echo = TRUE)
library(fudukue)
library(dualband)
# load core functions and libraries
library(imager)
library(EBImage)
library(pri)
set_read_img("jpg")
```

# Demo

## Pre-processing

```{r get_images}
img_files <- dir("../sample_data/", pattern = ".jpg$", full.names = T)
img_files

raw_img <-
  read_imgs(img_files) %>%
  .^3 # correct gamma value

dualband::show(raw_img, browser = F, all = F)
```

## Divide images into small pieces

To divide images, the locations should be approximated.

```{r set_locations}
location_data <-
  tribble(
     ~ x,  ~ y, ~ size, ~ location,
     474,  501,    100,    "a",
    1497,  933,    100,    "b"
  )
location_data
```

The images are divided into a list of small images (3d array; called pieces).

```{r split_into_pieces}
img_pieces <-
  location_data %>%
  split(.$location) %>%
  map(~ img2piece(raw_img, .))

img_pieces %>% names

img_pieces %>%
  map(check_pieces)
```


## Detect markers

The 

```{r extract_regions}
marker_data <- 
  img_pieces %>%
  map(extract_marker)

marker_data$a %>% names
```

```{r args_extract}
args(extract_marker)
```

- white_ratio (double; 0--1)
  - 
- occupancy (double; 0--1)
  - lower limit 
- erode_size (int)
  - if the white regions are separated, the regions may be merged by increasing this factor
- .show (logical; **currently invalid**)
  - if true, show the mapping of the regions
- white_ref_ratio (double)
  - ratio of size of grey reference to white reflectance
  - may depend on geometries of the markers used
- margin_white_rato (double; 1--)
  - ratio of size of the the margin around white regions
  - increasing this factor usually enhances the stability of the leaf extraction
- outer_white_ratio (double; 1--)
  - ratio of size of outer rectangle to white reflectance
- .verbose (logical; **currently invalid**)
  - 

```{r check_regions}

view(marker_data$a$marker, browser = F, all = F)

view(marker_data$a$target, browser = F, all = F)

marker_data$a$center
```

```{r calculate_values}
result <-
  marker_data %>%
  map_df(summarise_marker, .id = "location")

result
```


```{r mapping_on_pieces}
img_pieces %>%
  map(~ binarize(., white_ratio = .95)) %>%
  map(piece2center) %>%
  {
    markered <<- map(., mask_marker)
    targeted <<- map(., mask_target)
  }

mapped_pieces <-
  seq_along(img_pieces) %>%
  lapply(., function(i){
    piece_false_color(img_pieces[[i]], markered[[i]], targeted[[i]])
    })

map(mapped_pieces, ~ dualband::show(., browser = F, all = T))
```

```{r mapping_on_pictures}
mapped_all <-
  img_false_color(raw_img, mapped_pieces)

dualband::show(mapped_all, browser = F, all = T)
```
